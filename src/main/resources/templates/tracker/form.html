<!DOCTYPE html>
<html layout:decorate="~{layout/formbase}">

<section layout:fragment="content" class='page-content'>
    <div class='content'>
        <h1>Create Tracker</h1>
        <form method='post' th:action='@{/admin/trackers/save}' th:object="${tracker}" class="tagiform">
            <input type='hidden' th:field='*{id}' />

            <div class='form-group row'>
                <div class='col-sm-3 col-form-label text-sm-right pr-0'><label class='mb-0'>Module</label></div>
                <div class='col-sm-9'>
                    <input class="form-control col-sm-8 col-md-6" type='text' th:field="*{module}" />
                </div>
            </div>

            <div class='form-group row'>
                <div class='col-sm-3 col-form-label text-sm-right pr-0'><label class='mb-0'>Slug</label></div>
                <div class='col-sm-9'>
                    <input class="form-control col-sm-8 col-md-6" type='text' th:field="*{slug}" />
                </div>
            </div>

            <div class='form-group row'>
                <div class='col-sm-3 col-form-label text-sm-right pr-0'><label class='mb-0'>Name</label></div>
                <div class='col-sm-9'>
                    <input class="form-control col-sm-8 col-md-6" type='text' th:field="*{name}" />
                </div>
            </div>
            <div class='form-group row'>
                <div class='col-sm-3 col-form-label text-sm-right pr-0'><label class='mb-0'>Type</label></div>
                <div class='col-sm-9'>
                    <select class="form-control col-sm-8 col-md-6" th:field="*{trackerType}">
                        <option th:each="opt,iter: ${tracker.typeOptions}" th:text="${opt}" th:value="${opt}"
                            th:selected="${opt==tracker.trackerType}">
                        </option>
                    </select>
                </div>
            </div>
            
            <div class='form-group row'>
                <div class='col-sm-3 col-form-label text-sm-right pr-0'>
                    <label class='mb-0'>Default Status</label></div>
                <div class='col-sm-9'>
                    <input class="form-control col-sm-8 col-md-6 tokeninput statusselection" data-tokenlimit='1' type='text' th:field="*{defaultStatus}" />
                </div>
            </div>
            
            <div class='form-group row'>
                <div class='col-sm-3 col-form-label text-sm-right pr-0'>
                    <label class='mb-0'>View List Roles</label></div>
                <div class='col-sm-9'>
                    <input class="form-control col-sm-8 col-md-6 tokeninput roleselection" type='text' th:field="*{viewListRoles}" />
                </div>
            </div>
            
            <div class='form-group row'>
                <div class='col-sm-3 col-form-label text-sm-right pr-0'>
                    <label class='mb-0'>New Record Roles</label></div>
                <div class='col-sm-9'>
                    <input class="form-control col-sm-8 col-md-6 tokeninput roleselection" type='text' th:field="*{addRoles}" />
                </div>
            </div>
            
            <div class='form-group row'>
                <div class='col-sm-3 col-form-label text-sm-right pr-0'>
                    <label class='mb-0'>View Detail Roles</label></div>
                <div class='col-sm-9'>
                    <input class="form-control col-sm-8 col-md-6 tokeninput roleselection" type='text' th:field="*{detailRoles}" />
                </div>
            </div>
            
            <div class='form-group row'>
                <div class='col-sm-3 col-form-label text-sm-right pr-0'>
                    <label class='mb-0'>Edit Roles</label></div>
                <div class='col-sm-9'>
                    <input class="form-control col-sm-8 col-md-6 tokeninput roleselection" type='text' th:field="*{editRoles}" />
                </div>
            </div>
            
            <div class='form-group row'>
                <div class='col-sm-3 col-form-label text-sm-right pr-0'>
                    <label class='mb-0'>Delete Roles</label></div>
                <div class='col-sm-9'>
                    <input class="form-control col-sm-8 col-md-6 tokeninput roleselection" type='text' th:field="*{deleteRoles}" />
                </div>
            </div>
            
            <div class='form-group row'>
                <div class='col-sm-3 col-form-label text-sm-right pr-0'><label class='mb-0'>List Fields</label></div>
                <div class='col-sm-9'>
                <textarea class="form-control col-sm-8 col-md-6 tokeninput fieldselection" th:field="*{listFields}"></textarea>
                </div>
            </div>
            <div class='form-group row'>
                <div class='col-sm-3 col-form-label text-sm-right pr-0'><label class='mb-0'>Excel Fields</label></div>
                <div class='col-sm-9'>
                <textarea class="form-control col-sm-8 col-md-6 tokeninput fieldselection" th:field="*{excelFields}"></textarea>
                </div>
            </div>
            <div class='form-group row'>
                <div class='col-sm-3 col-form-label text-sm-right pr-0'><label class='mb-0'>Form Fields</label></div>
                <div class='col-sm-9'>
                    <textarea class="form-control col-sm-8 col-md-6 tokeninput fieldselection" th:field="*{formFields}"></textarea>
                </div>
            </div>
            <div class='form-group row'>
                <div class='col-sm-3 col-form-label text-sm-right pr-0'><label class='mb-0'>Display Fields</label></div>
                <div class='col-sm-9'>
                    <textarea class="form-control col-sm-8 col-md-6 tokeninput fieldselection" th:field="*{displayFields}"></textarea>
                </div>
            </div>
            <div class='form-group row'>
                <div class='col-sm-3 col-form-label text-sm-right pr-0'><label class='mb-0'>Search Fields</label></div>
                <div class='col-sm-9'>
                    <textarea class="form-control col-sm-8 col-md-6 tokeninput fieldselection" th:field="*{searchFields}"></textarea>
                </div>
            </div>
            <div class='form-group row'>
                <div class='col-sm-3 col-form-label text-sm-right pr-0'><label class='mb-0'>Filter Fields</label></div>
                <div class='col-sm-9'>
                    <textarea class="form-control col-sm-8 col-md-6 tokeninput fieldselection" th:field="*{filterFields}"></textarea>
                </div>
            </div>
            <div class='form-group row'>
                <div class='col-sm-3 col-form-label text-sm-right pr-0'><label class='mb-0'>Initial Status</label></div>
                <div class='col-sm-9'>
                    <input class="form-control col-sm-8 col-md-6" type='text' th:field="*{initialStatus}"/>
                </div>
            </div>
            <div class='form-group row'>
                <div class='col-sm-3 col-form-label text-sm-right pr-0'><label class='mb-0'>Data Table</label></div>
                <div class='col-sm-9'>
                    <input class="form-control col-sm-8 col-md-6" type='text' th:field="*{dataTable}" />
                </div>
            </div>

            <div class='form-group row'>
                <div class='col-sm-3 col-form-label text-sm-right pr-0'>
                    <label class='mb-0'>Updates Table</label>
                </div>
                <div class='col-sm-9'>
                    <input class="form-control col-sm-8 col-md-6" type='text' th:field="*{updatesTable}" />
                </div>
            </div>

            <div class='form-group row'>
                <div class="offset-md-3 col-md-9">
                    <button class='btn btn-info' name='save'>Save</button>
                    <button class='btn btn-secondary' name='cancel'>Cancel</button>
                </div>
            </div>
        </form>
    </div>
</section>
<th:block layout:fragment="page-javascript">
<script>
function splitval(val) {
	console.log(val);
	var tokens = val.split(",");
	var toreturn = [];
	tokens.forEach(function(entry){
		var currow = {id:entry,name:entry};
		toreturn.push(currow);
	});
	return toreturn;
};

function tokenselection(item,url) {
	var curval = item.val();
	if(curval.length>0){
		var pp = splitval(curval);	
	}
	else{
		var pp = null;
	}
	console.log('tl:' + item.data('tokenlimit'));
	item.tokenInput(
			url,
			{
				prePopulate: pp,
				preventDuplicates: true,
				tokenLimit: item.data('tokenlimit')
			}
	);
}

$(".fieldselection").each(function(){
	tokenselection($(this),"[[@{/api/trackers/{tracker_id}/fields(tracker_id=${tracker.id})}]]");	
});

$(".roleselection").each(function(){
	tokenselection($(this),"[[@{/api/trackers/{tracker_id}/roles(tracker_id=${tracker.id})}]]");
});

$(".statusselection").each(function(){
	tokenselection($(this),"[[@{/api/trackers/{tracker_id}/status(tracker_id=${tracker.id})}]]");
});
</script>
</th:block>
</html>