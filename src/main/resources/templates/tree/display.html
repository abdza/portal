<!DOCTYPE html>
<html layout:decorate="~{treebase}">

<section layout:fragment="content" class='page-content'>

	<div class="row">
		<div class="card border-0 col-12">
			<div class="card-header bgc-default-d2">
				<h3 th:text="${tree.name}" class="card-title text-130 text-white"></h3>
				<div class="card-toolbar">
				<a id="addnode" th:href="@{/trees/nodes/{parent_id}/create(parent_id=${tree.root.id})}" href="#" class="card-toolbar-btn text-white">
				<i class="fa fa-plus"></i>
				</a>
				</div>
			</div>
			<div class="card-body bgc-white border-1 border-t-0 brc-default-m2">
				<div id="tree" name="tree"></div>
			</div>
		</div>
	</div>

</section>

<th:block layout:fragment="javascript">
	<script th:inline="javascript">
		$('#tree').fancytree({
			source : {
				url : /*[[@{/api/trees/{treeid}(treeid=${tree.id})}]]*/'/dummy/api/users',
			},
			activate : function(event,data) {
				$("#addnode").attr("href","/trees/nodes/" + data.node.key + "/create");
			},
			modifyChild: function(event,data) {
				console.log("node");
				console.log(data.node);
				console.log("childNode");
				console.log(data.childNode);
				console.log("operation");
				console.log(data.operation);
			},
			extensions: ["dnd5"],
			dnd5: {
				preventVoidModes: true,
				preventRecursion: true,
				dragStart: function(node, data) {
					data.effectAllowed = "all";
					data.dropEffect = data.dropEffectSuggested;
					return true;
				},
				dragEnter: function(node, data) {
					data.node.info("dragEnter", data);
					return true;
				},
				dragOver: function(node, data) {
					data.dropEffect = data.dropEffectSuggested;
					return true;
				},
				dragEnd: function(node, data) {
					data.node.info("dragEnd", data);
				},
				dragDrop: function(node, data) {
					var sourceNodes = data.otherNodeList,
						copyMode = data.dropEffect !== "move";
					
					if(data.hitMode === "after"){
						sourceNodes.reverse();
					}
					
					if( copyMode ) {
						$.each(sourceNodes, function(i, o){
							o.CopyTo(node, data.hitMode, function(n){
								delete n.key;
								n.selected = false;
								n.title  = "Copy of " + n.title;
							});
						});
					} else {
						$.each(sourceNodes, function(i, o){
							o.moveTo(node, data.hitMode);
						});
					}
					node.setExpanded();
				}
				
			}
		});
	</script>
</th:block>
</html>